<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ã€Šå€«æ•¦è’™é›£è¨˜ã€‹æ¨ç†è§£è¬ï½œç°¡åŒ–ç‰ˆï¼ˆä½é›£åº¦ï¼‰</title>
<meta name="description" content="ä»¥å­«ä¸­å±±å€«æ•¦è’™é›£äº‹ä»¶ç‚ºä¸»é¡Œçš„ä½é›£åº¦æ¨ç†è§£è¬å°éŠæˆ²ã€‚åŒ…å«å¯†ç¢¼ç ´è­¯ã€è·¯å¾‘é‡å»ºã€è­‰æ“šæ­¸é¡ã€ç¾…é¦¬æ•¸å­—é–‹é–ï¼Œä»¥åŠæ•´åˆå»¶çºŒæ€§æ¸¬é©—ã€‚" />
<style>
  :root{ --bg:#0e1320; --panel:#101827; --ink:#e6efff; --muted:#9db0cf; --accent:#ffb84d; --accent2:#70d6ff; --ok:#1ad1a5; --warn:#ff6b6b; }
  *{box-sizing:border-box}
  body{margin:0; color:var(--ink); background:linear-gradient(180deg,#0a0f1a,#0e1320); font-family:system-ui,-apple-system,"Noto Sans TC","Microsoft JhengHei",Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  header{padding:28px 18px; text-align:center; background:linear-gradient(180deg,#101827,#0f1626); border-bottom:1px solid #1f2c48}
  header h1{margin:0 0 6px; font-size:1.8rem; letter-spacing:1px}
  header p{margin:0; color:var(--muted)}
  .wrap{max-width:1100px; margin:20px auto; padding:0 16px}
  .hud{display:grid; gap:10px; grid-template-columns: 1fr auto; align-items:center; background:var(--panel); border:1px solid #1f2c48; padding:12px; border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,.25)}
  .progress{height:10px; background:#1b2743; border-radius:99px; overflow:hidden}
  .progress>div{height:100%; width:0%; background:linear-gradient(90deg, var(--accent), #ffd27a); transition:width 400ms ease}
  .badges{display:flex; gap:8px; flex-wrap:wrap}
  .badge{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid #26345a; border-radius:999px; background:rgba(255,255,255,.03); color:var(--muted); font-size:12px}
  .badge.ok{color:var(--ok); border-color:#235f54; background:rgba(26,209,165,.06)}

  .grid{display:grid; gap:14px}
  @media(min-width:860px){ .grid-2{grid-template-columns:1fr 1fr} }

  .card{background:linear-gradient(180deg, #131c2e, #0f1727); border:1px solid #1f2c48; border-radius:14px; padding:14px; box-shadow:0 8px 26px rgba(0,0,0,.3)}
  h2{font-size:1.25rem; margin:4px 0 8px}
  h3{font-size:1.05rem; margin:6px 0}
  p.muted,.muted{color:var(--muted)}
  .btn{appearance:none; border:1px solid #274064; background:linear-gradient(180deg,#1d2d4a,#16233b); color:#eaf2ff; border-radius:10px; padding:10px 14px; cursor:pointer; font-weight:700}
  .btn:hover{filter:brightness(1.06)}
  .btn.ghost{background:transparent}
  .ok{color:var(--ok)}
  .warn{color:var(--warn)}
  .hidden{display:none !important}

  .cipherPanel{border:1px dashed #2b3a64; border-radius:12px; padding:12px; background:#0e1425}
  .cipherText{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; letter-spacing:2px; background:#0a1020; border:1px solid #1c2848; padding:10px; border-radius:8px}
  .slider{width:100%}

  .map{display:grid; grid-template-columns:repeat(2,1fr); gap:10px}
  .place{padding:12px; border:1px solid #25375e; border-radius:10px; background:linear-gradient(180deg,#121b2d,#0d1425); cursor:pointer}
  .place.selected{outline:2px solid var(--accent2)}
  .path{display:flex; gap:6px; flex-wrap:wrap; margin-top:6px}
  .crumb{padding:4px 8px; background:#13203a; border:1px solid #26426f; border-radius:999px; font-size:12px}

  .board{display:grid; gap:10px; grid-template-columns:1fr 1fr 1fr}
  .zone{min-height:120px; border:1px dashed #2b3a64; border-radius:12px; padding:8px; background:#0c1426}
  .zone h4{margin:0 0 6px; color:#9cc0ff}
  .clue{display:inline-block; margin:6px; padding:6px 10px; border:1px solid #2a3b60; background:#17233a; border-radius:999px; cursor:grab; font-size:13px}

  .hint{color:#d6d2a3; background:linear-gradient(180deg,#2b2815,#1e1b0f); border:1px solid #5d4c1a; padding:8px; border-radius:10px}

  .lock{display:grid; grid-template-columns:repeat(4,60px); gap:8px; justify-content:center; margin:10px 0}
  .dial{display:flex; align-items:center; justify-content:center; height:60px; border-radius:10px; background:#101827; border:1px solid #2a3c66; font-size:22px; user-select:none}
  .dial button{all:unset; display:block; width:100%; height:100%; color:#ffd27a; text-align:center; font-weight:700; cursor:pointer}

  /* Puzzle 5 visuals */
  .p5-block{border:1px solid #26345a; border-radius:12px; padding:12px; background:#121a2c; margin-bottom:10px}
  .p5-choices label{display:block; padding:8px; border:1px solid #2a3c66; border-radius:10px; margin-bottom:6px; cursor:pointer}
  select{padding:8px; border-radius:8px; border:1px solid #2a3c66; background:#0c1426; color:var(--ink)}

</style>
</head>
<body>
  <header>
    <h1>å€«æ•¦è¡Œå‹•æª”æ¡ˆï½œã€Šå€«æ•¦è’™é›£è¨˜ã€‹æ¨ç†è§£è¬ï¼ˆä½é›£åº¦ï¼‰</h1>
    <p>é€éäº”å€‹äº’å‹•é—œå¡ï¼Œæ‹¼å‡º 1896 å¹´å€«æ•¦äº‹ä»¶çš„è„ˆçµ¡ã€é—œéµäººç‰©ã€æ³•ç†è¦é»èˆ‡è¡Œå‹•å½±éŸ¿ã€‚</p>
  </header>

  <div class="wrap">
    <div class="hud">
      <div style="display:flex; align-items:center; gap:10px; justify-content:space-between">
        <div class="badges" id="badgeBar">
          <span class="badge" id="b1">ğŸ” å¯†ç¢¼ç ´è­¯</span>
          <span class="badge" id="b2">ğŸ—ºï¸ è·¯å¾‘é‡å»º</span>
          <span class="badge" id="b3">ğŸ“Œ è­‰æ“šæ­¸é¡</span>
          <span class="badge" id="b4">ğŸ§³ é–‹é–è¡Œå‹•</span>
          <span class="badge" id="b5">ğŸ§  å»¶çºŒæ€§æ•´åˆé¡Œ</span>
        </div>
      </div>
      <div style="min-width:260px">
        <div class="progress"><div id="pg"></div></div>
        <div class="muted" style="text-align:right"><span id="pgTxt">0/5</span> é—œå¡å®Œæˆ</div>
      </div>
    </div>

    <!-- Puzzle 1: Caesar cipher -->
    <section class="card" id="p1">
      <h2>é—œå¡ä¸€ï½œå¯†ç¢¼ç ´è­¯ï¼šæˆªç²çš„ç´™æ¢</h2>
      <p class="muted">ä½¿ç”¨ä½ç§»æ»‘æ¡¿å˜—è©¦ç ´è­¯å…©æ®µæ–‡å­—ï¼Œè§£å‡ºåœ°é»èˆ‡äººç‰©ã€‚</p>
      <div class="grid grid-2">
        <div class="cipherPanel">
          <h3>ç·šç´¢ Aï¼ˆåœ°é»ï¼‰</h3>
          <div class="cipherText" id="cipherA"></div>
          <label>ä½ç§»ï¼š<input type="range" min="0" max="25" value="0" class="slider" id="shiftA"></label>
          <div class="muted">è§£ç¢¼çµæœï¼š<span id="plainA">â€”</span></div>
        </div>
        <div class="cipherPanel">
          <h3>ç·šç´¢ Bï¼ˆäººç‰©ï¼‰</h3>
          <div class="cipherText" id="cipherB"></div>
          <label>ä½ç§»ï¼š<input type="range" min="0" max="25" value="0" class="slider" id="shiftB"></label>
          <div class="muted">è§£ç¢¼çµæœï¼š<span id="plainB">â€”</span></div>
        </div>
      </div>
      <div style="margin-top:10px; display:flex; gap:8px">
        <button class="btn" id="checkP1">æª¢æŸ¥</button>
        <button class="btn ghost" id="hintP1">æç¤º</button>
      </div>
      <p id="p1Res"></p>
      <div id="p1Explain" class="hidden">
        <h3>è¬›è§£</h3>
        <p class="muted">æ¸…æœé§å€«æ•¦ä½¿é¤¨ä½æ–¼ <em>Portland Place</em> ä¸€å¸¶ï¼›æ•‘æ´é—œéµäººç‰©ç‚º <em>James Cantlieï¼ˆåº·å¾·é»ï¼‰</em>ã€‚</p>
      </div>
    </section>

    <!-- Puzzle 2: Map order -->
    <section class="card" id="p2">
      <h2>é—œå¡äºŒï½œè·¯å¾‘é‡å»ºï¼šå€«æ•¦åœ°åœ–æ¿</h2>
      <p class="muted">ä¾äº‹ä»¶æ¨é€²é †åºé»é¸åœ°é»ï¼Œå½¢æˆè·¯å¾‘ï¼ˆ5 æ­¥ï¼‰ã€‚</p>
      <div class="map" id="map">
        <div class="place" data-k="A">ğŸ›ï¸ æ¸…ä½¿é¤¨ï¼ˆPortland Placeï¼‰</div>
        <div class="place" data-k="B">ğŸ‘¨â€âš•ï¸ é†«å¸«å¯“æ‰€ï¼ˆåº·å¾·é»ï¼‰</div>
        <div class="place" data-k="C">ğŸ“° å ±ç¤¾ï¼ˆThe Times ç­‰ï¼‰</div>
        <div class="place" data-k="D">ğŸ‘® è˜‡æ ¼è˜­å ´ï¼ˆå€«æ•¦è­¦å¯Ÿå»³ï¼‰</div>
        <div class="place" data-k="E">ğŸ¤ è‹±åœ‹å¤–äº¤éƒ¨ï¼ˆForeign Officeï¼‰</div>
      </div>
      <div class="path" id="path"></div>
      <div style="margin-top:10px; display:flex; gap:8px">
        <button class="btn" id="undoPath">æ’¤éŠ·ä¸€æ­¥</button>
        <button class="btn" id="checkP2">æª¢æŸ¥</button>
        <button class="btn ghost" id="hintP2">æç¤º</button>
      </div>
      <p id="p2Res"></p>
      <div id="p2Explain" class="hidden">
        <h3>è¬›è§£</h3>
        <p class="muted">äº‹ä»¶æ¨é€²ï¼šä½¿é¤¨æ‹˜ç¦ â†’ åº·å¾·é»æ±‚åŠ© â†’ åª’é«”é—œæ³¨ â†’ è­¦æ–¹ä»‹å…¥ â†’ å¤–äº¤éƒ¨æ–½å£“ï¼ˆè€Œå¾Œç²é‡‹ï¼‰ã€‚</p>
      </div>
    </section>

    <!-- Puzzle 3: Evidence board -->
    <section class="card" id="p3">
      <h2>é—œå¡ä¸‰ï½œè­‰æ“šæ­¸é¡ï¼šæ¡ˆä»¶æ¨æ¼”æ¿</h2>
      <p class="muted">å°‡ç·šç´¢æ‹–å…¥æ­£ç¢ºé¡åˆ¥ï¼ˆæ³•ç†ï¼è¼¿è«–ï¼è¡Œå‹•ï¼‰ã€‚è‡³å°‘æ”¾å° 6/7 å³å¯éé—œã€‚</p>
      <div style="display:flex; flex-wrap:wrap">
        <span class="clue" draggable="true" data-cat="law">å¤–äº¤è±å…</span>
        <span class="clue" draggable="true" data-cat="law">äººèº«è‡ªç”±</span>
        <span class="clue" draggable="true" data-cat="op">åª’é«”å ±å°</span>
        <span class="clue" draggable="true" data-cat="op">åœ‹éš›é—œæ³¨</span>
        <span class="clue" draggable="true" data-cat="act">è­¦æ–¹ä»‹å…¥</span>
        <span class="clue" draggable="true" data-cat="act">å¤–äº¤éƒ¨æ–½å£“</span>
        <span class="clue" draggable="true" data-cat="act">åº·å¾·é»å¥”èµ°</span>
      </div>
      <div class="board" style="margin-top:10px">
        <div class="zone" data-zone="law"><h4>æ³•ç†</h4></div>
        <div class="zone" data-zone="op"><h4>è¼¿è«–</h4></div>
        <div class="zone" data-zone="act"><h4>è¡Œå‹•</h4></div>
      </div>
      <div style="margin-top:10px; display:flex; gap:8px">
        <button class="btn" id="checkP3">æª¢æŸ¥</button>
        <button class="btn ghost" id="hintP3">æç¤º</button>
      </div>
      <p id="p3Res"></p>
      <div id="p3Explain" class="hidden">
        <h3>è¬›è§£</h3>
        <p class="muted">ä¸‰è‚¡åŠ›é‡äº’å‹•ï¼š<strong>æ³•ç†</strong>ï¼ˆå¤–äº¤è±å…ã€äººèº«è‡ªç”±ï¼‰ã€<strong>è¼¿è«–</strong>ï¼ˆåª’é«”å ±å°ã€åœ‹éš›é—œæ³¨ï¼‰ã€<strong>è¡Œå‹•</strong>ï¼ˆè­¦æ–¹èˆ‡å¤–äº¤éƒ¨ä»‹å…¥ã€åº·å¾·é»å¥”èµ°ï¼‰ã€‚</p>
      </div>
    </section>

    <!-- Puzzle 4: Safe lock (Roman numerals hint) -->
    <section class="card" id="p4">
      <h2>é—œå¡å››ï½œé–‹é–è¡Œå‹•ï¼šä½¿é¤¨å¯†æ«ƒ</h2>
      <p class="muted">é–‹å•Ÿé»‘å…‰æª¢è¦–å­—è·¡ï¼Œå°‡ç¾…é¦¬æ•¸å­—è½‰ç‚ºå¹´ä»½å¾Œé–‹é–ã€‚</p>
      <div class="hint" style="margin-bottom:8px">
        <label><input type="checkbox" id="uvToggle"> é–‹å•Ÿé»‘å…‰ï¼ˆé¡¯ç¤ºéš±è—å¢¨è·¡ï¼‰</label>
        <div id="uvMsg" class="muted">é»‘å…‰é—œé–‰ä¸­</div>
      </div>
      <div style="position:relative; padding:10px; border:1px solid #2a3c66; border-radius:10px; background:linear-gradient(180deg,#0e141f,#0b101a)">
        <div class="muted">ä¾¿æ¢ç´™ï¼š</div>
        <p style="margin:6px 0 0">ã€Œ<span class="uv hidden" id="uv1">Anno: <strong>MDCCCXCVI</strong></span><span class="uvOff">å¢¨è·¡æ¨¡ç³Šï¼Œåªçœ‹è¦‹å¹¾å€‹ç­†ç•«èˆ‡å­—æ¯æ®˜å½±ã€‚</span>ã€</p>
      </div>
      <div class="lock" id="lockYear">
        <div class="dial"><button data-idx="0">0</button></div>
        <div class="dial"><button data-idx="1">0</button></div>
        <div class="dial"><button data-idx="2">0</button></div>
        <div class="dial"><button data-idx="3">0</button></div>
      </div>
      <div style="display:flex; gap:8px; justify-content:center">
        <button class="btn" id="checkP4">è§£é–</button>
        <button class="btn ghost" id="hintP4">æç¤º</button>
      </div>
      <p id="p4Res"></p>
      <div id="p4Explain" class="hidden">
        <h3>è¬›è§£</h3>
        <p class="muted">ç¾…é¦¬æ•¸å­— <em>MDCCCXCVI</em> å°æ‡‰ <strong>1896</strong>ã€‚äº‹ä»¶ç™¼ç”Ÿæ–¼ 1896 å¹´ 10 æœˆä¸¦å¼•ç™¼å„ç•Œé—œæ³¨ã€‚</p>
      </div>
    </section>

    <!-- Puzzle 5: Integrative continuity quiz -->
    <section class="card" id="p5">
      <h2>é—œå¡äº”ï½œå»¶çºŒæ€§æ•´åˆé¡Œ</h2>
      <p class="muted">æ ¹æ“šå‰å››é—œçš„è³‡è¨Šï¼Œå®Œæˆä¸‹åˆ—ä¸‰éƒ¨åˆ†æ¸¬é©—ï¼ˆä¸éœ€è¼¸å…¥å§“åï¼‰ã€‚</p>

      <!-- Part A: multi-select actors -->
      <div class="p5-block">
        <h3>ï¼ˆAï¼‰å“ªäº›åŠ›é‡ç›´æ¥ä¿ƒæˆå­«ä¸­å±±ç²é‡‹ï¼Ÿï¼ˆå¯è¤‡é¸ï¼‰</h3>
        <div class="p5-choices">
          <label><input type="checkbox" name="actors" value="cantlie"> åº·å¾·é»ï¼ˆJames Cantlieï¼‰</label>
          <label><input type="checkbox" name="actors" value="media"> è‹±åœ‹åª’é«”ï¼ˆå¦‚ The Timesï¼‰</label>
          <label><input type="checkbox" name="actors" value="yard"> è˜‡æ ¼è˜­å ´ï¼ˆå€«æ•¦è­¦å¯Ÿå»³ï¼‰</label>
          <label><input type="checkbox" name="actors" value="fo"> è‹±åœ‹å¤–äº¤éƒ¨ï¼ˆForeign Officeï¼‰</label>
          <label><input type="checkbox" name="actors" value="macartney"> é¦¬å˜‰ç†ï¼ˆHalliday Macartneyï¼‰</label>
          <label><input type="checkbox" name="actors" value="location"> ä½¿é¤¨æ‰€åœ¨åœ°ï¼ˆPortland Placeï¼‰</label>
        </div>
      </div>

      <!-- Part B: sequence dropdowns -->
      <div class="p5-block">
        <h3>ï¼ˆBï¼‰åœ¨ã€Œåª’é«”é—œæ³¨ã€ä¹‹å¾Œï¼Œåˆç†çš„ä¸‹ä¸€æ­¥æ˜¯ï¼Ÿ</h3>
        <select id="p5Next1">
          <option value="">â€” è«‹é¸æ“‡ â€”</option>
          <option value="police">è­¦æ–¹ä»‹å…¥ï¼ˆè˜‡æ ¼è˜­å ´ï¼‰</option>
          <option value="fo">å¤–äº¤éƒ¨æ–½å£“</option>
          <option value="location">å›åˆ°ä½¿é¤¨ç¾å ´</option>
        </select>
        <h3 style="margin-top:10px">ï¼ˆCï¼‰åœ¨ã€Œè­¦æ–¹ä»‹å…¥ã€ä¹‹å¾Œï¼Œåˆç†çš„ä¸‹ä¸€æ­¥æ˜¯ï¼Ÿ</h3>
        <select id="p5Next2">
          <option value="">â€” è«‹é¸æ“‡ â€”</option>
          <option value="fo">å¤–äº¤éƒ¨æ–½å£“</option>
          <option value="media">å†æ¬¡åª’é«”æ›å…‰</option>
          <option value="macartney">èˆ‡é¦¬å˜‰ç†è«‡åˆ¤</option>
        </select>
      </div>

      <!-- Part D: law principle MCQ -->
      <div class="p5-block">
        <h3>ï¼ˆDï¼‰æ³•ç†äº’å‹•çš„ç†è§£ï¼ˆå–®é¸ï¼‰</h3>
        <div class="p5-choices">
          <label><input type="radio" name="law" value="correct"> ä½¿é¤¨ä¸»å¼µå¤–äº¤è±å…ï¼Œä½†è‹±åœ‹ç¤¾æœƒå¼·èª¿äººèº«è‡ªç”±ï¼›å…©è€…çš„ç•Œç·šåœ¨æ­¤äº‹ä»¶ä¸­æˆç‚ºå…¬å…±è¨è«–ç„¦é»ã€‚</label>
          <label><input type="radio" name="law" value="wrong1"> å¤–äº¤è±å…æ„å‘³ä½¿é¤¨å¯ä¸å—ä»»ä½•æ³•å¾‹é™åˆ¶ï¼Œè­¦æ–¹èˆ‡å¤–äº¤éƒ¨ä¸å¾—ä»‹å…¥ã€‚</label>
          <label><input type="radio" name="law" value="wrong2"> äººèº«è‡ªç”±ä¿éšœåªé©ç”¨æœ¬åœ‹å…¬æ°‘ï¼Œæ•…æ­¤æ¡ˆä¸æ§‹æˆçˆ­è­°ã€‚</label>
        </div>
      </div>

      <div style="display:flex; gap:8px">
        <button class="btn" id="checkP5">é€å‡ºç­”æ¡ˆ</button>
        <button class="btn ghost" id="resetP5">é‡è¨­</button>
      </div>
      <p id="p5Res"></p>
      <div id="p5Explain" class="hidden">
        <h3>è¬›è§£èˆ‡ç¸½çµ</h3>
        <ul class="muted">
          <li><strong>ç›´æ¥æ¨åŠ›ï¼š</strong>åº·å¾·é»çš„å¥”èµ°èˆ‡è‹±åª’å ±å°åŒ¯èšç¤¾æœƒå£“åŠ›ï¼›è­¦æ–¹èˆ‡å¤–äº¤éƒ¨ä»¥åˆ¶åº¦èˆ‡æ¬Šè²¬ä»‹å…¥ï¼Œå½¢æˆå¤šæ–¹åˆåŠ›ã€‚</li>
          <li><strong>åºåˆ—ï¼š</strong>åª’é«”é—œæ³¨ä¹‹å¾Œé€šå¸¸æ˜¯è­¦æ–¹ä»‹å…¥ï¼Œå†ç”±å¤–äº¤éƒ¨æ–½å£“æ–¼ä½¿é¤¨ç«¯ã€‚</li>
          <li><strong>æ³•ç†ï¼š</strong>å¤–äº¤è±å…ä¸¦éç„¡é‚Šç•Œï¼›åœ¨è‹±åœ‹æ³•èˆ‡ç¤¾æœƒå¸¸è­˜ä¸­ï¼Œäººèº«è‡ªç”±ä»æ˜¯æ ¸å¿ƒåƒ¹å€¼ï¼Œæ•…å¼•ç™¼å…¬é–‹è¾¯è«–èˆ‡æ”¿åºœè¡Œå‹•ã€‚</li>
        </ul>
      </div>
    </section>
  </div>

  <footer style="text-align:center; color:var(--muted); padding:24px">Â© 2025 æ¨ç†è§£è¬æ•™è‚²é ï¼ˆå–®æª”ã€ç„¡å¤–æ›ï¼‰ã€‚æ­·å²è³‡è¨Šæ¡å¸¸è¦‹å²æ–™æ¦‚è¿°ï¼›ç­–å±•ä½¿ç”¨è«‹æ­é…æ­£å¼æ–‡ç»ã€‚</footer>

<script>
  // ---- HUD / Progress ----
  const state = {p1:false,p2:false,p3:false,p4:false,p5:false};
  const pg = document.getElementById('pg');
  const pgTxt = document.getElementById('pgTxt');
  const badges = [ 'b1','b2','b3','b4','b5' ].map(id=>document.getElementById(id));
  function updateProgress(){
    const done = Object.values(state).filter(Boolean).length; const pct = Math.round(done/5*100);
    pg.style.width = pct+'%'; pgTxt.textContent = `${done}/5 é—œå¡å®Œæˆ`;
    badges.forEach((b, i)=>{ b.classList.toggle('ok', Object.values(state)[i]); });
  }

  // ---- Puzzle 1: Caesar cipher ----
  const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
  const pA = 'PORTLAND PLACE';
  const pB = 'JAMES CANTLIE';
  function caesarEnc(plain, shift){
    return plain.toUpperCase().split('').map(ch=>{
      const idx = alphabet.indexOf(ch); if(idx<0) return ch; return alphabet[(idx+shift)%26];
    }).join('');
  }
  function caesarDec(cipher, shift){
    return cipher.toUpperCase().split('').map(ch=>{
      const idx = alphabet.indexOf(ch); if(idx<0) return ch; return alphabet[(idx-(shift%26)+26)%26];
    }).join('');
  }
  const shiftA = Math.floor(Math.random()*25)+1; const shiftB = Math.floor(Math.random()*25)+1;
  const cA = caesarEnc(pA, shiftA); const cB = caesarEnc(pB, shiftB);
  document.getElementById('cipherA').textContent = cA;
  document.getElementById('cipherB').textContent = cB;
  const sA = document.getElementById('shiftA');
  const sB = document.getElementById('shiftB');
  const plainA = document.getElementById('plainA');
  const plainB = document.getElementById('plainB');
  function renderPlain(){ plainA.textContent = caesarDec(cA, parseInt(sA.value,10)); plainB.textContent = caesarDec(cB, parseInt(sB.value,10)); }
  sA.addEventListener('input', renderPlain); sB.addEventListener('input', renderPlain); renderPlain();
  document.getElementById('hintP1').addEventListener('click', ()=>{ alert('æç¤ºï¼šåœ°é»ç‚ºå…©å­—ï¼ˆP é–‹é ­ï¼‰ï¼Œäººç‰©æ˜¯æ—©å¹´æ©å¸«ï¼ˆJ é–‹é ­ï¼‰ã€‚'); });
  document.getElementById('checkP1').addEventListener('click', ()=>{
    const ok = (plainA.textContent.trim()===pA && plainB.textContent.trim()===pB);
    const res = document.getElementById('p1Res'); const exp = document.getElementById('p1Explain');
    if(ok){ res.textContent='âœ… ç ´è­¯æˆåŠŸï¼'; res.className='ok'; exp.classList.remove('hidden'); state.p1=true; updateProgress(); }
    else { res.textContent='âŒ å°šæœªæ­£ç¢ºï¼Œå†èª¿æ•´ä½ç§»ã€‚'; res.className='warn'; }
  });

  // ---- Puzzle 2: Map order ----
  const correctPath = ['A','B','C','D','E']; const sel = [];
  document.querySelectorAll('.place').forEach(el=>{
    el.addEventListener('click', ()=>{
      if(sel.length>=5) return; const k = el.dataset.k; sel.push(k); el.classList.add('selected');
      const node = document.createElement('span'); node.className='crumb'; node.textContent = el.textContent;
      document.getElementById('path').appendChild(node);
    });
  });
  document.getElementById('undoPath').addEventListener('click', ()=>{
    if(sel.length===0) return; const last = sel.pop();
    const cards = [...document.querySelectorAll('.place')]; cards.find(c=>c.dataset.k===last).classList.remove('selected');
    const crumbs = document.getElementById('path'); crumbs.removeChild(crumbs.lastElementChild);
  });
  document.getElementById('hintP2').addEventListener('click', ()=>{ alert('æç¤ºï¼šä½¿é¤¨â†’é†«å¸«â†’åª’é«”â†’è­¦æ–¹â†’å¤–äº¤éƒ¨ã€‚'); });
  document.getElementById('checkP2').addEventListener('click', ()=>{
    const res = document.getElementById('p2Res'); if(sel.length!==5){ res.textContent='è«‹å…ˆé¸æ»¿ 5 å€‹åœ°é»ã€‚'; res.className='warn'; return; }
    const ok = sel.every((v,i)=> v===correctPath[i]);
    if(ok){ res.textContent='âœ… è·¯å¾‘æ­£ç¢ºï¼'; res.className='ok'; document.getElementById('p2Explain').classList.remove('hidden'); state.p2=true; updateProgress(); }
    else { res.textContent='âŒ è·¯å¾‘ä¸å°ï¼Œå†æª¢è¦–è³‡è¨Šæµå‘ã€‚'; res.className='warn'; }
  });

  // ---- Puzzle 3: Evidence board ----
  const clues = [...document.querySelectorAll('.clue')]; let dragging=null;
  clues.forEach(c=>{ c.addEventListener('dragstart',()=>{ dragging=c; c.classList.add('dragging'); }); c.addEventListener('dragend',()=>{ dragging=null; c.classList.remove('dragging'); }); });
  document.querySelectorAll('.zone').forEach(z=>{
    z.addEventListener('dragover', (e)=>{ e.preventDefault(); });
    z.addEventListener('drop', ()=>{ if(dragging) z.appendChild(dragging); });
  });
  document.getElementById('hintP3').addEventListener('click', ()=>{ alert('æç¤ºï¼šæ³•ç†=å¤–äº¤è±å…/äººèº«è‡ªç”±ï¼›è¼¿è«–=åª’é«”/åœ‹éš›ï¼›è¡Œå‹•=è­¦æ–¹/å¤–äº¤éƒ¨/åº·å¾·é»ã€‚'); });
  document.getElementById('checkP3').addEventListener('click', ()=>{
    const zones = { law:document.querySelector('[data-zone="law"]'), op:document.querySelector('[data-zone="op"]'), act:document.querySelector('[data-zone="act"]') };
    const countCorrect = type=>[...zones[type].querySelectorAll('.clue')].filter(c=> c.dataset.cat===type).length;
    const good = countCorrect('law') + countCorrect('op') + countCorrect('act');
    const res = document.getElementById('p3Res');
    if(good>=6){ res.textContent=`âœ… æ­¸é¡å®Œæˆï¼æ­£ç¢º ${good}/7ã€‚`; res.className='ok'; document.getElementById('p3Explain').classList.remove('hidden'); state.p3=true; updateProgress(); }
    else { res.textContent=`âŒ ç›®å‰æ­£ç¢º ${good}/7ï¼Œé‚„å·®ä¸€é»ã€‚`; res.className='warn'; }
  });

  // ---- Puzzle 4: Safe lock ----
  const dialsY = [...document.querySelectorAll('#lockYear .dial button')]; const digitsY = [0,0,0,0];
  dialsY.forEach(btn=>{ btn.addEventListener('click', ()=>{ const idx = parseInt(btn.dataset.idx,10); digitsY[idx] = (digitsY[idx]+1)%10; btn.textContent = digitsY[idx]; }); });
  document.getElementById('uvToggle').addEventListener('change', (e)=>{
    const on = e.target.checked; document.getElementById('uvMsg').textContent = on ? 'é»‘å…‰é–‹å•Ÿï¼šéš±è—å¢¨è·¡å¯è¦‹ã€‚' : 'é»‘å…‰é—œé–‰ä¸­';
    document.querySelectorAll('.uv').forEach(el=> el.classList.toggle('hidden', !on)); document.querySelectorAll('.uvOff').forEach(el=> el.classList.toggle('hidden', on));
  });
  document.getElementById('hintP4').addEventListener('click', ()=>{ alert('æç¤ºï¼šå°‡ç¾…é¦¬æ•¸å­—è½‰æˆé˜¿æ‹‰ä¼¯æ•¸å­—ã€‚'); });
  document.getElementById('checkP4').addEventListener('click', ()=>{
    const res = document.getElementById('p4Res'); const okYear = (digitsY.join('')==='1896');
    if(okYear){ res.textContent='âœ… å·²è§£é–ï¼'; res.className='ok'; document.getElementById('p4Explain').classList.remove('hidden'); state.p4=true; updateProgress(); }
    else { res.textContent='âŒ çµ„åˆä¸å°ï¼Œæ‰“é–‹é»‘å…‰å†æ‰¾ç·šç´¢ã€‚'; res.className='warn'; }
  });

  // ---- Puzzle 5: Integrative quiz ----
  function getChecked(name){ return [...document.querySelectorAll(`input[name="${name}"]:checked`)].map(i=>i.value); }
  document.getElementById('checkP5').addEventListener('click', ()=>{
    // A: actors
    const a = getChecked('actors');
    const aOK = ['cantlie','media','yard','fo'];
    const aCorrect = a.length===aOK.length && a.every(v=> aOK.includes(v));

    // B & C: sequence
    const n1 = document.getElementById('p5Next1').value; // after media -> police
    const n2 = document.getElementById('p5Next2').value; // after police -> FO
    const seqOK = (n1==='police' && n2==='fo');

    // D: law
    const law = (document.querySelector('input[name="law"]:checked')||{}).value;
    const lawOK = (law==='correct');

    const res = document.getElementById('p5Res'); const exp = document.getElementById('p5Explain');
    const allOK = aCorrect && seqOK && lawOK;
    if(allOK){ res.textContent='âœ… å…¨éƒ¨æ­£ç¢ºï¼ä½ å·²å®Œæˆæ•´åˆé¡Œã€‚'; res.className='ok'; exp.classList.remove('hidden'); state.p5=true; updateProgress(); }
    else {
      let msg = 'âŒ å°šæœªå…¨å°ï¼š';
      if(!aCorrect) msg += 'ï¼ˆAï¼‰å†æª¢è¦–å“ªäº›åŠ›é‡å±¬æ–¼ç›´æ¥æ¨åŠ›ï¼›';
      if(!seqOK) msg += 'ï¼ˆBï¼‰ï¼ˆCï¼‰è·¯å¾‘é †åºå†æƒ³æƒ³ï¼›';
      if(!lawOK) msg += 'ï¼ˆDï¼‰æ³•ç†äº’å‹•éœ€æ³¨æ„å¤–äº¤è±å…èˆ‡äººèº«è‡ªç”±çš„ç•Œç·šã€‚';
      res.textContent = msg; res.className='warn';
    }
  });
  document.getElementById('resetP5').addEventListener('click', ()=>{
    document.querySelectorAll('input[name="actors"]').forEach(i=> i.checked=false);
    document.getElementById('p5Next1').value=''; document.getElementById('p5Next2').value='';
    const selLaw = document.querySelector('input[name="law"]:checked'); if(selLaw) selLaw.checked=false;
    document.getElementById('p5Res').textContent=''; document.getElementById('p5Explain').classList.add('hidden');
    state.p5=false; updateProgress();
  });
</script>
</body>
</html>